<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QA Compare - Aplikacja do porównywania</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsdiff/5.1.0/diff.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .file-input-button {
            display: inline-block;
            background: #4f46e5;
            color: white;
            border: none;
            border-radius: 0.375rem;
            padding: 0.5rem 1rem;
            outline: none;
            white-space: nowrap;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
        }

        .file-input-button:hover {
            background: #4338ca;
        }

        .diff-added,
        .diff-removed {
            background-color: #fee2e2;
            color: #991b1b;
            padding: 1px 2px;
            border-radius: 3px;
        }

        .diff-removed {
            text-decoration: line-through;
        }

        #image-modal {
            background-color: rgba(0, 0, 0, 0.8);
        }

        #modal-img {
            max-height: 90vh;
            max-width: 90vw;
        }

        .zoomable-image {
            cursor: zoom-in;
        }

        .drop-zone {
            transition: background-color 0.2s, border-color 0.2s;
        }

        .drag-over {
            background-color: #eef2ff;
            border-color: #4f46e5;
            border-style: dashed;
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-800">

    <div id="app-container" class="min-h-screen p-4 sm:p-6 lg:p-8 relative">
        <header class="mb-8 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">QA Compare</h1>
            <p class="text-gray-600 mt-2">Inteligentne narzędzie do weryfikacji wizualnej i tekstowej.</p>
        </header>

        <button id="refresh-btn"
            class="absolute top-4 right-4 sm:top-6 sm:right-6 bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors">Refresh</button>

        <div id="notification" class="hidden mb-4 p-4 rounded-md text-white max-w-4xl mx-auto"></div>

        <div id="setup-section" class="bg-white p-6 md:p-8 rounded-xl shadow-lg max-w-4xl mx-auto">
            <h2 class="text-xl md:text-2xl font-semibold mb-6 text-center">1. Wczytaj dane</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 md:gap-8">
                <div id="masters-drop-zone"
                    class="drop-zone text-center p-4 border-2 border-dashed border-gray-300 rounded-lg">
                    <label for="masters-dir-input" class="file-input-button">Masters</label>
                    <input type="file" id="masters-dir-input" webkitdirectory directory multiple class="hidden" />
                    <div id="masters-file-list"
                        class="mt-3 text-xs text-gray-500 bg-gray-50 rounded-md p-2 border max-h-32 overflow-y-auto">
                        Przeciągnij i upuść katalog lub kliknij, aby wybrać.</div>
                </div>
                <div id="adaptations-drop-zone"
                    class="drop-zone text-center p-4 border-2 border-dashed border-gray-300 rounded-lg">
                    <label for="adaptations-dir-input" class="file-input-button">Adaptations</label>
                    <input type="file" id="adaptations-dir-input" webkitdirectory directory multiple class="hidden" />
                    <div id="adaptations-file-list"
                        class="mt-3 text-xs text-gray-500 bg-gray-50 rounded-md p-2 border max-h-32 overflow-y-auto">
                        Przeciągnij i upuść katalog lub kliknij, aby wybrać.</div>
                </div>
                <div id="translations-drop-zone"
                    class="drop-zone text-center p-4 border-2 border-dashed border-gray-300 rounded-lg">
                    <label for="translations-file-input" class="file-input-button">Translation</label>
                    <input type="file" id="translations-file-input" accept=".csv,.xlsx" class="hidden" />
                    <div id="translations-file-list"
                        class="mt-3 text-xs text-gray-500 bg-gray-50 rounded-md p-2 border max-h-32 overflow-y-auto">
                        Przeciągnij i upuść plik lub kliknij, aby wybrać.</div>
                </div>
            </div>
            <div class="mt-8 text-center">
                <button id="process-btn"
                    class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-indigo-700 transition-transform transform hover:scale-105 disabled:bg-gray-400 disabled:cursor-not-allowed disabled:transform-none">
                    Compare
                </button>
            </div>
        </div>

        <div id="confirmation-modal"
            class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
            <div class="bg-white p-8 rounded-lg shadow-xl text-center">
                <h3 id="confirmation-title" class="text-xl font-bold mb-4">Gotowy do przetwarzania</h3>
                <p id="confirmation-text" class="mb-6"></p>
                <div class="flex justify-center gap-4">
                    <button id="cancel-batch-btn"
                        class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400">Anuluj</button>
                    <button id="start-batch-btn"
                        class="bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-indigo-700">Start</button>
                </div>
            </div>
        </div>

        <div id="loader"
            class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex flex-col items-center justify-center z-50">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-white"></div>
            <p id="loader-text" class="text-white text-lg mt-4">Przetwarzanie...</p>
        </div>

        <div id="image-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
            <div class="absolute inset-0" id="modal-bg"></div>
            <img id="modal-img" src="" alt="Powiększony obraz" class="relative z-10 object-contain rounded-lg">
            <button id="modal-close" class="absolute top-4 right-4 text-white text-4xl font-bold">&times;</button>
        </div>

        <div id="results-section" class="hidden mt-8">
            <h2 class="text-2xl font-semibold mb-4 text-center">2. Wyniki porównania</h2>
            <div id="batch-progress-container" class="hidden max-w-4xl mx-auto mb-4">
                <div class="flex justify-between mb-1">
                    <span id="progress-text" class="text-base font-medium text-gray-700">Postęp</span>
                    <span id="progress-percentage" class="text-sm font-medium text-gray-700">0%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div id="progress-bar" class="bg-indigo-600 h-2.5 rounded-full" style="width: 0%"></div>
                </div>
            </div>
            <div class="flex flex-col lg:flex-row gap-8">
                <nav class="w-full lg:w-1/4 bg-white p-4 rounded-xl shadow-lg h-full max-h-[75vh] overflow-y-auto">
                    <h3 class="font-semibold mb-3 text-lg">Lista masterów</h3>
                    <div class="mb-4">
                        <input type="text" id="filter-input" placeholder="Filtruj masterów..."
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <ul id="masters-list" class="space-y-2">
                    </ul>
                </nav>

                <main id="comparison-panel" class="w-full lg:w-3/4">
                    <div id="welcome-message"
                        class="bg-white p-8 rounded-xl shadow-lg text-center h-full flex items-center justify-center">
                        <h3 class="text-lg font-medium text-gray-600">Wybierz master z listy po lewej stronie, aby
                            rozpocząć porównanie.</h3>
                    </div>
                    <div id="comparison-view" class="hidden">
                        <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                            <h3 id="comparison-title" class="text-xl md:text-2xl font-bold"></h3>
                            <div class="flex items-center flex-wrap gap-2 md:gap-4">
                                <div id="comparison-options" class="hidden">
                                    <label class="flex items-center text-sm cursor-pointer">
                                        <input type="checkbox" id="case-insensitive-checkbox"
                                            class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                        <span class="ml-2 text-gray-700">Ignoruj wielkość liter</span>
                                    </label>
                                </div>
                                <button id="export-pdf-btn"
                                    class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors text-sm">
                                    Eksportuj do PDF
                                </button>
                            </div>
                        </div>

                        <div id="pdf-content" class="space-y-6 bg-white p-4 md:p-6 rounded-xl shadow-lg">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <h4 class="font-semibold text-lg mb-2">Master</h4>
                                    <img id="master-img"
                                        class="w-full h-auto rounded-lg border border-gray-200 zoomable-image"
                                        alt="Obraz mastera">
                                </div>
                                <div>
                                    <h4 class="font-semibold text-lg mb-2">Adaptacja</h4>
                                    <img id="adaptation-img"
                                        class="w-full h-auto rounded-lg border border-gray-200 zoomable-image"
                                        alt="Obraz adaptacji">
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <h4 class="font-semibold text-lg mb-2">Teksty referencyjne (z pliku)</h4>
                                    <div id="csv-texts"
                                        class="bg-gray-50 p-4 rounded-lg text-sm space-y-3 whitespace-pre-wrap"></div>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-lg mb-2">Teksty wykryte (z adaptacji JPG)</h4>
                                    <div id="ocr-texts"
                                        class="bg-gray-50 p-4 rounded-lg text-sm space-y-3 whitespace-pre-wrap min-h-[100px]">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="batch-navigation" class="hidden text-center mt-6 flex justify-center gap-4">
                        <button id="prev-batch-btn"
                            class="bg-gray-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-gray-700 transition-colors disabled:bg-gray-400">
                            Previous
                        </button>
                        <button id="next-batch-btn"
                            class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-indigo-700 transition-colors disabled:bg-indigo-400">
                            Next
                        </button>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let masterFiles = [];
        let adaptationFiles = [];
        let translationsData = [];
        let allMatchedPairs = [];
        let currentBatchIndex = 0;
        const BATCH_SIZE = 4;
        let tesseractWorker = null;
        let currentOcrLang = null;
        let currentMasterId = null;

        // Map 2-letter language codes to 3-letter Tesseract codes
        const langCodeMap = {
            'cs': 'ces', 'pl': 'pol', 'sk': 'slk', 'ru': 'rus', 'uk': 'ukr', 'bs': 'bos',
            'bg': 'bul', 'hr': 'hrv', 'me': 'srp_latn', 'mk': 'mkd', 'rs': 'srp', 'sr': 'srp_latn',
            'sl': 'slv', 'en': 'eng', 'nl': 'nld', 'de': 'deu', 'da': 'dan', 'is': 'isl',
            'no': 'nor', 'sv': 'swe', 'fr': 'fra', 'pt': 'por', 'ro': 'ron', 'es': 'spa',
            'it': 'ita', 'lv': 'lav', 'lt': 'lit', 'el': 'ell', 'sq': 'sqi', 'fi': 'fin',
            'et': 'est', 'hu': 'hun', 'hy': 'hye', 'arm': 'hye', 'az': 'aze', 'tr': 'tur'
        };

        // Element references
        const processBtn = document.getElementById('process-btn');
        const setupSection = document.getElementById('setup-section');
        const resultsSection = document.getElementById('results-section');
        const mastersList = document.getElementById('masters-list');
        const comparisonView = document.getElementById('comparison-view');
        const welcomeMessage = document.getElementById('welcome-message');
        const loader = document.getElementById('loader');
        const loaderText = document.getElementById('loader-text');
        const exportPdfBtn = document.getElementById('export-pdf-btn');
        const notification = document.getElementById('notification');
        const imageModal = document.getElementById('image-modal');
        const modalImg = document.getElementById('modal-img');
        const caseInsensitiveCheckbox = document.getElementById('case-insensitive-checkbox');
        const refreshBtn = document.getElementById('refresh-btn');
        const filterInput = document.getElementById('filter-input');
        const mastersDropZone = document.getElementById('masters-drop-zone');
        const adaptationsDropZone = document.getElementById('adaptations-drop-zone');
        const translationsDropZone = document.getElementById('translations-drop-zone');
        const batchProgressContainer = document.getElementById('batch-progress-container');
        const progressText = document.getElementById('progress-text');
        const progressPercentage = document.getElementById('progress-percentage');
        const progressBar = document.getElementById('progress-bar');
        const batchNavigation = document.getElementById('batch-navigation');
        const nextBatchBtn = document.getElementById('next-batch-btn');
        const prevBatchBtn = document.getElementById('prev-batch-btn');
        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmationText = document.getElementById('confirmation-text');
        const startBatchBtn = document.getElementById('start-batch-btn');
        const cancelBatchBtn = document.getElementById('cancel-batch-btn');

        // File list display elements
        const mastersFileList = document.getElementById('masters-file-list');
        const adaptationsFileList = document.getElementById('adaptations-file-list');
        const translationsFileList = document.getElementById('translations-file-list');

        // Event Listeners
        document.getElementById('masters-dir-input').addEventListener('change', e => {
            masterFiles = Array.from(e.target.files);
            updateFileList(mastersFileList, masterFiles);
            checkInputsState();
        });
        document.getElementById('adaptations-dir-input').addEventListener('change', e => {
            adaptationFiles = Array.from(e.target.files);
            updateFileList(adaptationsFileList, adaptationFiles);
            checkInputsState();
        });
        document.getElementById('translations-file-input').addEventListener('change', e => handleTranslationsFile(e.target.files));
        processBtn.addEventListener('click', processData);
        exportPdfBtn.addEventListener('click', generatePdf);
        document.getElementById('master-img').addEventListener('click', (e) => openImageModal(e.target.src));
        document.getElementById('adaptation-img').addEventListener('click', (e) => openImageModal(e.target.src));
        document.getElementById('modal-close').addEventListener('click', closeImageModal);
        document.getElementById('modal-bg').addEventListener('click', closeImageModal);
        caseInsensitiveCheckbox.addEventListener('change', () => {
            if (currentMasterId) {
                handleMasterSelection(currentMasterId, false);
            }
        });
        refreshBtn.addEventListener('click', () => {
            window.location.reload();
        });
        filterInput.addEventListener('input', filterMasters);
        nextBatchBtn.addEventListener('click', () => changeBatch(1));
        prevBatchBtn.addEventListener('click', () => changeBatch(-1));
        startBatchBtn.addEventListener('click', startBatchProcessing);
        cancelBatchBtn.addEventListener('click', () => confirmationModal.classList.add('hidden'));

        // Drag and Drop Listeners
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            mastersDropZone.addEventListener(eventName, preventDefaults, false);
            adaptationsDropZone.addEventListener(eventName, preventDefaults, false);
            translationsDropZone.addEventListener(eventName, preventDefaults, false);
        });

        ['dragenter', 'dragover'].forEach(eventName => {
            mastersDropZone.addEventListener(eventName, () => mastersDropZone.classList.add('drag-over'), false);
            adaptationsDropZone.addEventListener(eventName, () => adaptationsDropZone.classList.add('drag-over'), false);
            translationsDropZone.addEventListener(eventName, () => translationsDropZone.classList.add('drag-over'), false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            mastersDropZone.addEventListener(eventName, () => mastersDropZone.classList.remove('drag-over'), false);
            adaptationsDropZone.addEventListener(eventName, () => adaptationsDropZone.classList.remove('drag-over'), false);
            translationsDropZone.addEventListener(eventName, () => translationsDropZone.classList.remove('drag-over'), false);
        });

        mastersDropZone.addEventListener('drop', handleDrop, false);
        adaptationsDropZone.addEventListener('drop', handleDrop, false);
        translationsDropZone.addEventListener('drop', handleDrop, false);

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        async function handleDrop(e) {
            preventDefaults(e);
            const targetDropZone = e.currentTarget;
            targetDropZone.classList.remove('drag-over');

            const items = e.dataTransfer.items;
            if (!items) return;

            showLoader('Przetwarzanie upuszczonych plików...');

            const allFiles = [];

            try {
                for (let i = 0; i < items.length; i++) {
                    const entry = items[i].webkitGetAsEntry();
                    if (entry) {
                        if (entry.isDirectory) {
                            // ✅ POPRAWA: Rekurencyjne wczytywanie
                            const dirFiles = await getFilesFromDirectory(entry);
                            allFiles.push(...dirFiles);
                        } else if (entry.isFile) {
                            const file = await getFile(entry);
                            allFiles.push(file);
                        }
                    }
                }

                console.log(`📁 Wczytano ${allFiles.length} plików z drag&drop`);

                if (targetDropZone.id === 'masters-drop-zone') {
                    masterFiles = allFiles.filter(f => f.name.toLowerCase().endsWith('.jpg') || f.name.toLowerCase().endsWith('.jpeg') || f.name.toLowerCase().endsWith('.png'));
                    updateFileList(mastersFileList, masterFiles);
                } else if (targetDropZone.id === 'adaptations-drop-zone') {
                    adaptationFiles = allFiles.filter(f => f.name.toLowerCase().endsWith('.jpg') || f.name.toLowerCase().endsWith('.jpeg') || f.name.toLowerCase().endsWith('.png'));
                    updateFileList(adaptationsFileList, adaptationFiles);
                } else if (targetDropZone.id === 'translations-drop-zone') {
                    const validFiles = allFiles.filter(f => f.name.toLowerCase().endsWith('.csv') || f.name.toLowerCase().endsWith('.xlsx'));
                    if (validFiles.length > 0) {
                        handleTranslationsFile(validFiles);
                    } else {
                        showNotification('Upuszczono nieprawidłowy plik. Proszę upuścić plik .csv lub .xlsx.', 'error');
                    }
                }
                checkInputsState();
            } catch (err) {
                console.error("Błąd podczas przetwarzania upuszczonych plików:", err);
                showNotification("Wystąpił błąd podczas przetwarzania upuszczonych plików.", "error");
            } finally {
                hideLoader();
            }
        }

        function filterMasters(e) {
            const searchTerm = e.target.value.toLowerCase();
            const listItems = mastersList.querySelectorAll('li');
            listItems.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        function updateFileList(element, files) {
            if (files.length === 0) {
                element.innerHTML = 'Wybierz pliki...';
                return;
            }
            element.innerHTML = files.map(f => `<div class="truncate">${f.name}</div>`).join('');
        }

        function checkInputsState() {
            if (masterFiles.length > 0 && adaptationFiles.length > 0 && translationsData.length > 0) {
                processBtn.disabled = false;
            } else {
                processBtn.disabled = true;
            }
        }

        function showNotification(message, type = 'error') {
            notification.textContent = message;
            notification.className = `mb-4 p-4 rounded-md text-white ${type === 'error' ? 'bg-red-500' : 'bg-green-500'}`;
            notification.classList.remove('hidden');
        }

        function handleTranslationsFile(files) {
            const file = files[0];
            if (!file) return;

            updateFileList(translationsFileList, [file]);
            const reader = new FileReader();

            if (file.name.endsWith('.csv')) {
                reader.onload = (event) => {
                    const text = event.target.result;
                    const rows = text.split(/\r?\n/).filter(row => row.trim() !== '');
                    if (rows.length < 2) {
                        translationsData = [];
                        showNotification('Błąd: Pusty lub nieprawidłowy plik CSV.', 'error');
                        return;
                    }
                    const headers = rows.shift().split(';').map(h => h.trim());
                    translationsData = rows.map(row => {
                        const values = row.split(';');
                        return headers.reduce((obj, header, index) => {
                            obj[header] = values[index] ? values[index].trim() : '';
                            return obj;
                        }, {});
                    });
                    checkInputsState();
                };
                reader.readAsText(file, 'UTF-8');
            } else if (file.name.endsWith('.xlsx')) {
                reader.onload = (event) => {
                    try {
                        const data = new Uint8Array(event.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        translationsData = XLSX.utils.sheet_to_json(worksheet);
                        checkInputsState();
                    } catch (err) {
                        translationsData = [];
                        showNotification('Błąd podczas odczytu pliku XLSX.', 'error');
                        console.error(err);
                    }
                };
                reader.readAsArrayBuffer(file);
            }
        }

        function showLoader(text = 'Przetwarzanie...') {
            loaderText.textContent = text;
            loader.classList.remove('hidden');
        }

        function hideLoader() {
            loader.classList.add('hidden');
        }

        function openImageModal(src) {
            modalImg.src = src;
            imageModal.classList.remove('hidden');
        }

        function closeImageModal() {
            imageModal.classList.add('hidden');
            modalImg.src = '';
        }

        // ✅ NOWA FUNKCJA: Zarządzanie pamięcią
        function forceGarbageCollection() {
            // Wyczyść URL objects
            document.querySelectorAll('img').forEach(img => {
                if (img.src && img.src.startsWith('blob:')) {
                    URL.revokeObjectURL(img.src);
                }
            });

            // Wymuś garbage collection jeśli dostępne
            if (typeof window.gc === 'function') {
                window.gc();
            }
        }
        // ✅ NOWA FUNKCJA: Zmniejszanie obrazów przed OCR
        async function resizeImageForOCR(imageFile) {
            return new Promise((resolve, reject) => {
                try {
                    const img = new Image();
                    img.onload = () => {
                        const MAX_WIDTH = 1500;
                        const MAX_HEIGHT = 1500;

                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > MAX_WIDTH) {
                                height *= MAX_WIDTH / width;
                                width = MAX_WIDTH;
                            }
                        } else {
                            if (height > MAX_HEIGHT) {
                                width *= MAX_HEIGHT / height;
                                height = MAX_HEIGHT;
                            }
                        }

                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        canvas.toBlob(blob => {
                            URL.revokeObjectURL(img.src);
                            resolve(blob);
                        }, 'image/jpeg', 0.9);
                    };

                    img.onerror = (e) => {
                        URL.revokeObjectURL(img.src);
                        reject(new Error(`Nie udało się załadować obrazu: ${e.message}`));
                    };

                    img.src = URL.createObjectURL(imageFile);
                } catch (error) {
                    reject(error);
                }
            });
        }
        // Drag & Drop Helper Functions
        function getFile(fileEntry) {
            return new Promise((resolve, reject) => {
                fileEntry.file(file => resolve(file), err => reject(err));
            });
        }

        async function getFilesFromDirectory(directoryEntry) {
            const files = [];

            async function readDirectory(dirEntry) {
                const reader = dirEntry.createReader();

                const readAllEntries = () => {
                    return new Promise((resolve, reject) => {
                        const allEntries = [];

                        const readBatch = () => {
                            reader.readEntries((entries) => {
                                if (entries.length > 0) {
                                    allEntries.push(...entries);
                                    readBatch(); // Czytaj następną porcję
                                } else {
                                    resolve(allEntries); // Koniec
                                }
                            }, reject);
                        };

                        readBatch();
                    });
                };

                const entries = await readAllEntries();

                for (const entry of entries) {
                    if (entry.isFile) {
                        try {
                            const file = await getFile(entry);
                            files.push(file);
                        } catch (error) {
                            console.warn(`Nie udało się wczytać pliku: ${entry.name}`, error);
                        }
                    } else if (entry.isDirectory) {
                        // ✅ REKURENCJA: Wejdź do podfolderu
                        await readDirectory(entry);
                    }
                }
            }

            await readDirectory(directoryEntry);
            return files;
        }
        async function processData() {
            if (masterFiles.length === 0 || adaptationFiles.length === 0 || translationsData.length === 0) {
                showNotification('Proszę wybrać wszystkie wymagane pliki i katalogi.', 'error');
                return;
            }

            allMatchedPairs = [];
            // ✅ POPRAWKA: Proste dopasowywanie - pierwsze 10 znaków
            const masterMap = new Map(masterFiles.map(f => {
                const nameWithoutExt = f.name.substring(0, f.name.lastIndexOf('.'));
                const key = nameWithoutExt.substring(0, 10); // pierwsze 10 znaków
                return [key, f];
            }));

            const adaptationMap = new Map(adaptationFiles.map(f => {
                const nameWithoutExt = f.name.substring(0, f.name.lastIndexOf('.'));
                const key = nameWithoutExt.substring(0, 10); // pierwsze 10 znaków
                return [key, f];
            }));

            const idHeader = Object.keys(translationsData[0])[0];

            translationsData.forEach(row => {
                const masterId = String(row[idHeader]).trim();

                // ✅ NOWE: Inteligentne wyszukiwanie plików
                let masterFile = null;
                let adaptationFile = null;

                // Szukaj master file
                for (const [fileName, file] of masterMap) {
                    const fullName = file.name.substring(0, file.name.lastIndexOf('.'));
                    if (fullName.includes(masterId) || masterId.includes(fullName) ||
                        fullName.substring(0, 10) === masterId.substring(0, 10)) {
                        masterFile = file;
                        break;
                    }
                }

                // Szukaj adaptation file  
                for (const [fileName, file] of adaptationMap) {
                    const fullName = file.name.substring(0, file.name.lastIndexOf('.'));
                    if (fullName.includes(masterId) || masterId.includes(fullName) ||
                        fullName.substring(0, 10) === masterId.substring(0, 10)) {
                        adaptationFile = file;
                        break;
                    }
                }

                if (masterFile && adaptationFile) {
                    allMatchedPairs.push({ masterId, masterFile, adaptationFile, csvRow: row, status: 'pending' });
                } else {
                    console.log(`❌ Nie znaleziono dopasowania dla masterId: ${masterId}`);
                }
                }); // Zamknięcie forEach

            if (allMatchedPairs.length === 0) {
                showNotification('Nie udało się połączyć żadnych danych. Sprawdź, czy nazwy plików i ID w pliku z tłumaczeniami są zgodne.', 'error');
                return;
            }
            
            const totalFiles = allMatchedPairs.length;
            const totalBatches = Math.ceil(totalFiles / BATCH_SIZE);
            confirmationText.textContent = `Znaleziono ${totalFiles} plików. Zostaną one przetworzone w ${totalBatches} pakietach. Czy chcesz rozpocząć?`;
            confirmationModal.classList.remove('hidden');
        } // Zamknięcie processData()

        // ✅ Przenieś wszystkie funkcje NA ZEWNĄTRZ processData()
        

            async function startBatchProcessing() {
                confirmationModal.classList.add('hidden');
                setupSection.classList.add('hidden');
                resultsSection.classList.remove('hidden');
                notification.classList.add('hidden');
                currentBatchIndex = 0;
                await processBatch();
            }

            async function changeBatch(direction) {
                const newIndex = currentBatchIndex + direction;
                const totalBatches = Math.ceil(allMatchedPairs.length / BATCH_SIZE);

                if (newIndex >= 0 && newIndex < totalBatches) {
                    currentBatchIndex = newIndex;
                    await processBatch();
                }
            }

            // ✅ KOMPLETNIE PRZEPISANA FUNKCJA processBatch() - odporna na zawieszanie
            async function processBatch() {
                batchNavigation.classList.add('hidden');
                const startIndex = currentBatchIndex * BATCH_SIZE;
                const endIndex = startIndex + BATCH_SIZE;
                const batch = allMatchedPairs.slice(startIndex, endIndex);

                if (batch.length === 0) {
                    showNotification("Wszystkie pliki zostały przetworzone.", "success");
                    batchProgressContainer.classList.add('hidden');
                    return;
                }

                console.log(`🚀 Rozpoczynam przetwarzanie pakietu ${currentBatchIndex + 1}, plików: ${batch.length}`);
                batchProgressContainer.classList.remove('hidden');

                let processedInBatch = 0;
                let successCount = 0;
                let errorCount = 0;

                const langCode = batch.length > 0 ? getLangCode(batch[0].adaptationFile.name) : 'eng';
                const tesseractLang = langCodeMap[langCode] || 'eng';

                let worker = null;

                try {
                    worker = await getTesseractWorker(tesseractLang);
                } catch (error) {
                    console.error('❌ Błąd inicjalizacji Tesseract:', error);
                    showNotification('Błąd inicjalizacji silnika OCR', 'error');
                    return;
                }

                for (const item of batch) {
                    const startTime = Date.now();
                    console.log(`📄 Przetwarzam plik: ${item.masterId} (${processedInBatch + 1}/${batch.length})`);

                    // ✅ Większa przerwa między plikami
                    await new Promise(resolve => setTimeout(resolve, 100));

                    processedInBatch++;
                    const totalProcessed = startIndex + processedInBatch;
                    progressText.textContent = `Przetwarzanie pakietu ${currentBatchIndex + 1} z ${Math.ceil(allMatchedPairs.length / BATCH_SIZE)}`;
                    const percentage = Math.round((totalProcessed / allMatchedPairs.length) * 100);
                    progressPercentage.textContent = `${percentage}%`;
                    progressBar.style.width = `${percentage}%`;

                    let success = false;

                    try {
                        showLoader(`OCR: ${item.masterId} (${processedInBatch}/${batch.length})`);

                        // ✅ Zmniejsz obraz przed OCR
                        let processedImage;
                        try {
                            processedImage = await resizeImageForOCR(item.adaptationFile);
                            console.log(`📐 Obraz ${item.masterId} zmniejszony dla OCR`);
                        } catch (resizeError) {
                            console.warn(`⚠️ Nie udało się zmniejszyć obrazu ${item.masterId}, używam oryginału:`, resizeError);
                            processedImage = item.adaptationFile;
                        }

                        // ✅ OCR z timeoutem 30 sekund
                        const { data: { text } } = await Promise.race([
                            worker.recognize(processedImage),
                            new Promise((_, reject) =>
                                setTimeout(() => reject(new Error('OCR timeout - 30 sekund')), 30000)
                            )
                        ]);

                        const processingTime = Date.now() - startTime;
                        console.log(`✅ OCR zakończone dla ${item.masterId} w ${processingTime}ms`);

                        item.ocrText = text;
                        item.status = 'completed';
                        successCount++;
                        success = true;

                        // ✅ Cleanup processed image if it was resized
                        if (processedImage !== item.adaptationFile && processedImage instanceof Blob) {
                            URL.revokeObjectURL(processedImage);
                        }

                    } catch (error) {
                        const processingTime = Date.now() - startTime;
                        console.error(`❌ OCR Error dla ${item.masterId} po ${processingTime}ms:`, error.message);

                        item.ocrText = `Błąd OCR: ${error.message}`;
                        item.status = 'error';
                        errorCount++;
                        success = true; // Kontynuuj z następnym plikiem
                    }

                    // ✅ Oddanie kontroli UI
                    await new Promise(resolve => requestAnimationFrame(resolve));

                    // ✅ Dodatkowa przerwa po każdym pliku
                    await new Promise(resolve => setTimeout(resolve, 50));
                }

                // ✅ Sprzątanie workera
                if (worker) {
                    try {
                        await worker.terminate();
                        tesseractWorker = null;
                        console.log('🧹 Tesseract worker terminated');
                    } catch (error) {
                        console.error('⚠️ Error terminating worker:', error);
                    }
                }

                console.log(`🎉 Pakiet ${currentBatchIndex + 1} zakończony! Sukces: ${successCount}, Błędy: ${errorCount}`);

                hideLoader();
                populateMastersList(batch);
                updateBatchNavigation();

                // ✅ NOWE: Wyświetl obrazki pierwszego pliku po załadowaniu pakietu
                if (batch.length > 0) {
                    displayImages(batch[0]);
                }
                // ✅ NOWE: Wymuszone zwolnienie pamięci
                forceGarbageCollection();
            }

            function getLangCode(fileName) {
                const parts = fileName.split('_');
                return parts.length > 1 ? parts[parts.length - 1].split('.')[0].toLowerCase() : 'eng';
            }

            // ✅ POPRAWIONA FUNKCJA getTesseractWorker()
            async function getTesseractWorker(lang) {
                const langString = lang === 'eng' ? 'eng' : `${lang}+eng`;

                if (tesseractWorker) {
                    showLoader('Zwalnianie poprzedniego silnika OCR...');
                    await tesseractWorker.terminate();
                    tesseractWorker = null;
                    // Oddaj kontrolę UI po zwolnieniu
                    await new Promise(resolve => setTimeout(resolve, 100));
                }

                showLoader(`Inicjalizacja silnika OCR (${langString})...`);
                tesseractWorker = await Tesseract.createWorker(langString, 1, {
                    logger: m => { if (m.status === 'recognizing text') console.log(m) }
                });
                currentOcrLang = langString;

                hideLoader(); // ✅ DODANE: Ukryj loader po inicjalizacji
                return tesseractWorker;
            }

            function populateMastersList(batch) {
                mastersList.innerHTML = '';
                for (const item of batch) {
                    const li = document.createElement('li');
                    li.className = 'p-3 rounded-lg cursor-pointer hover:bg-indigo-100 transition-colors border border-transparent hover:border-indigo-200 flex items-center';
                    li.textContent = `Master ID: ${item.masterId}`;
                    li.dataset.id = item.masterId;
                    li.addEventListener('click', () => handleMasterSelection(item.masterId, true));
                    mastersList.appendChild(li);
                }
                if (batch.length > 0) {
                    handleMasterSelection(batch[0].masterId, true);
                }
            }

            function updateBatchNavigation() {
                const totalBatches = Math.ceil(allMatchedPairs.length / BATCH_SIZE);
                if (totalBatches > 1) {
                    batchNavigation.classList.remove('hidden');
                    prevBatchBtn.disabled = currentBatchIndex === 0;
                    nextBatchBtn.disabled = currentBatchIndex >= totalBatches - 1;
                } else {
                    batchNavigation.classList.add('hidden');
                }
            }
            function handleMasterSelection(id, isFullReload = true) {
                currentMasterId = id;
                document.querySelectorAll('#masters-list li').forEach(li => {
                    li.classList.remove('bg-indigo-200', 'border-indigo-300');
                    if (li.dataset.id === id) {
                        li.classList.add('bg-indigo-200', 'border-indigo-300');
                    }
                });

                welcomeMessage.classList.add('hidden');
                comparisonView.classList.remove('hidden');
                document.getElementById('comparison-options').classList.remove('hidden');

                const data = allMatchedPairs.find(p => p.masterId === id);
                document.getElementById('comparison-title').textContent = `Porównanie dla Mastera ID: ${id}`;

                if (isFullReload) {
                    const masterImg = document.getElementById('master-img');
                    const adaptationImg = document.getElementById('adaptation-img');
                    if (masterImg.src) URL.revokeObjectURL(masterImg.src);
                    if (adaptationImg.src) URL.revokeObjectURL(adaptationImg.src);

                    masterImg.src = URL.createObjectURL(data.masterFile);
                    adaptationImg.src = URL.createObjectURL(data.adaptationFile);
                }

                const { [Object.keys(data.csvRow)[0]]: idColumn, ds, lang, ...textsToCompare } = data.csvRow;
                const csvTextsContainer = document.getElementById('csv-texts');
                csvTextsContainer.innerHTML = '';
                for (const [key, value] of Object.entries(textsToCompare)) {
                    const p = document.createElement('p');
                    p.innerHTML = `<strong class="font-semibold">${key}:</strong> ${value || ''}`;
                    csvTextsContainer.appendChild(p);
                }

                const ocrContainer = document.getElementById('ocr-texts');
                ocrContainer.innerHTML = '';
                let overallStatus = 'success';
                const ocrLines = data.ocrText.split('\n').filter(line => line.trim() !== '');

                for (const [key, refText] of Object.entries(textsToCompare)) {
                    if (!refText) continue;

                    const bestMatch = findBestMatch(refText, ocrLines);

                    const p = document.createElement('p');
                    const strong = document.createElement('strong');
                    strong.className = 'font-semibold';
                    strong.textContent = `${key}: `;
                    p.appendChild(strong);

                    let comparisonResult;
                    if (bestMatch.text) {
                        comparisonResult = compareTexts(refText, bestMatch.text);
                    } else {
                        comparisonResult = compareTexts(refText, "");
                    }

                    if (comparisonResult.querySelector('.diff-added, .diff-removed')) {
                        overallStatus = 'error';
                    }

                    p.appendChild(comparisonResult);
                    ocrContainer.appendChild(p);
                }

                updateMasterStatus(id, overallStatus);
            }

            function normalizeText(str) {
                if (typeof str !== 'string') return '';
                return str
                    .replace(/[\s\u00A0]+/g, ' ')
                    .replace(/[\u2010-\u2015]/g, '-')
                    .replace(/[®™*]/g, '') // Remove special characters like ®, ™, *
                    .trim();
            }

            function levenshteinDistance(a, b) {
                if (a.length === 0) return b.length;
                if (b.length === 0) return a.length;
                const matrix = [];
                for (let i = 0; i <= b.length; i++) { matrix[i] = [i]; }
                for (let j = 0; j <= a.length; j++) { matrix[0][j] = j; }
                for (let i = 1; i <= b.length; i++) {
                    for (let j = 1; j <= a.length; j++) {
                        if (b.charAt(i - 1) === a.charAt(j - 1)) {
                            matrix[i][j] = matrix[i - 1][j - 1];
                        } else {
                            matrix[i][j] = Math.min(matrix[i - 1][j - 1] + 1, matrix[i][j - 1] + 1, matrix[i - 1][j] + 1);
                        }
                    }
                }
                return matrix[b.length][a.length];
            }

            function calculateSimilarity(str1, str2) {
                const ignoreCase = caseInsensitiveCheckbox.checked;
                let s1 = normalizeText(str1);
                let s2 = normalizeText(str2);

                if (ignoreCase) {
                    s1 = s1.toLowerCase();
                    s2 = s2.toLowerCase();
                }

                const maxLength = Math.max(s1.length, s2.length);
                if (maxLength === 0) return 1;

                const distance = levenshteinDistance(s1, s2);
                return 1 - (distance / maxLength);
            }

            function findBestMatch(refText, ocrLines) {
                if (!ocrLines || ocrLines.length === 0 || !refText) {
                    return { text: null, score: 0 };
                }

                let bestMatch = { text: null, score: -1 };

                for (const line of ocrLines) {
                    const score = calculateSimilarity(refText, line);
                    if (score > bestMatch.score) {
                        bestMatch = { text: line, score: score };
                    }
                }
                if (bestMatch.score > 0.95) { // Higher threshold for quick single-line match
                    return bestMatch;
                }

                for (let i = 0; i < ocrLines.length; i++) {
                    let currentCandidate = "";
                    for (let j = i; j < ocrLines.length; j++) {
                        currentCandidate = j === i ? ocrLines[j] : currentCandidate + ' ' + ocrLines[j];
                        const score = calculateSimilarity(refText, currentCandidate);
                        if (score > bestMatch.score) {
                            bestMatch.score = score;
                            bestMatch.text = currentCandidate;
                        }
                        if (currentCandidate.length > refText.length * 1.5 && score < 0.4) {
                            break;
                        }
                    }
                }

                return bestMatch.score > 0.55 ? bestMatch : { text: null, score: 0 }; // Lowered threshold for better matching with imperfect OCR
            }

            function compareTexts(text1, text2) {
                const nText1 = normalizeText(text1);
                const nText2 = normalizeText(text2);

                const ignoreCase = caseInsensitiveCheckbox.checked;
                const diff = Diff.diffWordsWithSpace(nText1, nText2, { ignoreCase: ignoreCase });
                const fragment = document.createDocumentFragment();

                let hasDifferences = false;
                diff.forEach(part => {
                    if (part.added || part.removed) {
                        hasDifferences = true;
                    }
                });

                if (!hasDifferences) {
                    const span = document.createElement('span');
                    span.appendChild(document.createTextNode(text1));
                    fragment.appendChild(span);
                    return fragment;
                }

                for (let i = 0; i < diff.length; i++) {
                    const part = diff[i];
                    const span = document.createElement('span');

                    if (part.added) {
                        span.className = 'diff-removed';
                        span.appendChild(document.createTextNode(part.value));
                        fragment.appendChild(span);
                    } else if (part.removed) {
                        if (!diff[i + 1] || !diff[i + 1].added) {
                            span.className = 'diff-removed';
                            span.style.textDecoration = 'line-through';
                            span.appendChild(document.createTextNode(part.value));
                            fragment.appendChild(span);
                        }
                    } else {
                        span.appendChild(document.createTextNode(part.value));
                        fragment.appendChild(span);
                    }
                }

                return fragment;
            }

            function updateMasterStatus(id, status) {
                const listItem = document.querySelector(`#masters-list li[data-id="${id}"]`);
                if (!listItem) return;
                const existingIcon = listItem.querySelector('span');
                if (existingIcon) existingIcon.remove();
                const icon = document.createElement('span');
                icon.className = `ml-auto w-3 h-3 rounded-full ${status === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
                listItem.classList.add('flex', 'items-center');
                listItem.appendChild(icon);
            }
            function generatePdf() {
                showLoader('Generowanie PDF...');
                const { jsPDF } = window.jspdf;
                const content = document.getElementById('pdf-content');
                const title = document.getElementById('comparison-title').textContent;

                html2canvas(content, { scale: 2, useCORS: true }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const canvasWidth = canvas.width;
                    const canvasHeight = canvas.height;
                    const ratio = canvasWidth / canvasHeight;
                    const imgWidth = pdfWidth - 20;
                    const imgHeight = imgWidth / ratio;

                    pdf.setFontSize(16);
                    pdf.text(title, 10, 15);
                    pdf.addImage(imgData, 'PNG', 10, 25, imgWidth, imgHeight);
                    pdf.save(`${title.replace(/ /g, '_')}.pdf`);
                    hideLoader();
                }).catch(err => {
                    console.error("Błąd podczas generowania PDF:", err);
                    showNotification("Wystąpił błąd podczas generowania pliku PDF.", "error");
                    hideLoader();
                });
            }

    </script>
</body>

</html>